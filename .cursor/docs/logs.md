# Logs

## 2024-12-19 - Реализация глобального блокировщика зума для PWA

### Изменения в файлах:

#### 1. index.html
- Обновлен meta viewport: `width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover`
- Добавлен `meta name="format-detection" content="telephone=no"`
- Убран дублирующийся meta viewport

#### 2. src/app/disableZoom.ts (новый файл)
- Создан блокировщик зума с функциями:
  - Принудительное обновление meta viewport
  - Блокировка pinch/gesture событий (iOS Safari)
  - Блокировка Ctrl+колесо (desktop)
  - Блокировка double-tap/double-click
  - Система cleanup для удаления обработчиков

#### 3. src/main.tsx
- Добавлена инициализация блокировщика зума
- Проверка переменной окружения `VITE_DISABLE_ZOOM === '1'`

#### 4. src/index.css
- Добавлены CSS стили для отключения зума:
  - `-webkit-text-size-adjust: 100%` для html
  - `touch-action: manipulation` для интерактивных элементов
  - `font-size: 16px` для input/textarea/select (iOS zoom prevention)

### Результат:
- Pinch-zoom и double-tap-zoom отключены на iOS/Android
- Ctrl+колесо не масштабирует страницу на desktop
- При фокусе на инпутах экран не увеличивается
- Поведение включается только при `VITE_DISABLE_ZOOM=1`

### Примечание:
Файл `.env` заблокирован для редактирования. Для тестирования нужно создать `.env.local` с `VITE_DISABLE_ZOOM=1` вручную.

## 2024-12-19 - Финальный фикс композера: z-[60] и прямое позиционирование

### Изменения в файлах:

#### src/pages/Coach.tsx
- Увеличен z-index композера до z-[60] (было z-45)
- Упрощено позиционирование: убрано calc() и env(safe-area-inset-bottom)
- Прямое вычисление: `bottom: ${tabbarHeight + safeArea}px`
- Добавлена детальная отладочная информация для позиционирования

### Результат:
- Композер теперь имеет z-[60], что значительно выше таббара (z-50)
- Позиционирование упрощено и должно работать надежнее
- Отладочная информация показывает точные координаты композера и таббара

## 2024-12-19 - Фикс z-index композера: композер теперь выше таббара

### Изменения в файлах:

#### src/pages/Coach.tsx
- Увеличен z-index композера с z-40 до z-45
- Композер теперь рендерится ПЕРЕД таббаром в DOM (порядок важен для z-index)
- Добавлена отладочная информация для проверки работы CSS переменной

#### src/shared/hooks/useTabbarHeight.ts
- Добавлена retry логика для поиска элемента #app-tabbar
- Хук теперь ждет до 1 секунды (10 попыток × 100ms) для появления элемента
- Добавлено логирование для отладки

### Результат:
- Композер теперь имеет z-45, что выше таббара (z-50)
- Порядок рендеринга в DOM исправлен: композер → таббар
- Хук более надежно находит и измеряет высоту таббара
- Отладочная информация поможет диагностировать проблемы

## 2024-12-19 - Фикс композера: убран дополнительный зазор над таббаром

### Изменения в файлах:

#### src/pages/Coach.tsx
- Убран дополнительный отступ `safe = 8` из расчета `bottomPad`
- Упрощен расчет: `bottomPad = composerH + tabbarH` (без лишних зазоров)
- Убрана зависимость от `kb` в `bottomPad` (клавиатура обрабатывается через `transform: translateY(-kb)`)
- Композер теперь располагается ровно над таббаром без дополнительных промежутков

### Результат:
- Композер виден ровно над таббаром, без доп. зазоров
- Список сообщений получает точный отступ: `composerH + tabbarH`
- При показе клавиатуры композер поднимается через `translateY(-kb)`
- Таббар (z-50) всегда выше композера (z-40), но композер не перекрывается

## 2024-12-19 - Исправление страницы Coach: композер над таббаром

### Изменения в файлах:

#### 1. src/shared/hooks/useTabbarHeight.ts
- Обновлен хук useTabbarHeight для корректной работы с CSS переменной
- Добавлен дефолт 64px для начального значения
- Улучшена логика с ResizeObserver и обработкой resize событий
- Хук теперь возвращает число и выставляет CSS переменную --tabbar-h

#### 2. src/pages/Coach.tsx
- Добавлен id="app-tabbar" для таббара с z-50 (было z-30)
- Убран ручной pb-20 из контейнера контента
- Добавлен расчет cssTabbarH через CSS переменную как fallback
- Улучшен расчет bottomPad с учетом CSS переменной
- Композер теперь корректно позиционируется над таббаром через bottom: calc(var(--tabbar-h, 64px) + safe-area)
- Композер имеет z-40 (ниже таббара z-50)

### Результат:
- Таббар теперь имеет правильный z-index и id для измерения высоты
- Композер корректно располагается над таббаром, не наслаиваясь на него
- При поднятии клавиатуры композер поднимается, таббар остается на месте
- Контент получает точный нижний отступ через bottomPad
- Убраны "липкие" отступы, все рассчитывается динамически