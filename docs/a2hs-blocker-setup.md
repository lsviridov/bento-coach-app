# A2HS Blocker Setup Guide

## Обзор

A2HS (Add to Home Screen) Blocker - это компонент, который блокирует доступ к приложению до тех пор, пока пользователь не установит PWA на домашний экран. Это обеспечивает лучший пользовательский опыт и увеличивает вероятность установки приложения.

## Функциональность

- **Полноэкранная блокировка** - перекрывает весь UI до установки
- **Автоопределение платформы** - iOS, Android, другие
- **In-app браузеры** - показывает инструкции для внешних браузеров
- **Dev-обход** - возможность отключить блокировку для разработки
- **Автоматическое определение установки** - через `display-mode: standalone`

## Установка

### 1. Переменные окружения

Создайте файл `.env.local` в корне проекта:

```bash
# A2HS Blocker Configuration
VITE_FORCE_A2HS=1  # Включить блокировку (по умолчанию)
```

### 2. Dev-обход

Для локальной разработки добавьте к URL параметр:
```
http://localhost:5173/?dev-bypass=1
```

## Конфигурация

### VITE_FORCE_A2HS

| Значение | Поведение |
|----------|-----------|
| `1` (по умолчанию) | Блокировка включена |
| `0` | Блокировка отключена |

### Автоматическое отключение

Блокировка автоматически отключается когда:
- PWA уже установлено (`display-mode: standalone`)
- В localStorage есть флаг `a2hs-installed=1`
- URL содержит `?dev-bypass=1`

## Платформы

### iOS (Safari)
1. Откройте в Safari
2. Нажмите "Поделиться" 
3. Выберите "На экран «Домой»"
4. Нажмите "Добавить"

### Android (Chrome)
1. Нажмите кнопку "Установить"
2. Подтвердите во всплывающем окне

### In-app браузеры
- Instagram, Facebook, Telegram
- Показывается сообщение "Откройте в Safari/Chrome"
- Кнопка "Скопировать ссылку"

## Технические детали

### События
- `beforeinstallprompt` - перехватывается для Android
- `appinstalled` - отслеживается для всех платформ

### Атрибуты DOM
- `overflow-hidden` на `body`
- `aria-hidden="true"` на `#root`
- `inert` на `#root` (блокирует фокус)

### Типы TypeScript
```typescript
interface BeforeInstallPromptEvent extends Event {
  readonly platforms: string[];
  readonly userChoice: Promise<{
    outcome: 'accepted' | 'dismissed';
    platform: string;
  }>;
  prompt(): Promise<void>;
}
```

## Тестирование

### Unit тесты
```bash
npm test -- src/features/a2hs-blocker/
```

### E2E тесты
```bash
npm run test:e2e
```

### Ручное тестирование
1. Откройте приложение в мобильном браузере
2. Убедитесь, что блокировка появляется
3. Установите PWA
4. Проверьте, что блокировка исчезла

## Troubleshooting

### Блокировка не появляется
- Проверьте `VITE_FORCE_A2HS=1`
- Убедитесь, что PWA не установлено
- Проверьте консоль на ошибки

### Блокировка не исчезает после установки
- Обновите страницу
- Проверьте `localStorage['a2hs-installed']`
- Убедитесь, что открыто в standalone режиме

### Проблемы с фокусом
- Проверьте атрибут `inert` на `#root`
- Убедитесь, что `aria-hidden` корректно управляется

## Производительность

- Компонент рендерится только при `shouldBlock=true`
- Минимальное влияние на бандл (~2KB gzipped)
- Использует `useMemo` для вычисления `shouldBlock`
- Автоматическая очистка event listeners

## Безопасность

- Не отправляет данные на сервер
- Использует только localStorage для состояния
- Проверяет `display-mode: standalone` через CSS
- Безопасная работа с `navigator.standalone`
